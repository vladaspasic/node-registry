<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/registry/registry.js - The Node Registry API</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/lucid.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
        
            The Node Registry API
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>0.1.7</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Container", "classes/DAG", "classes/EventEmitter", "classes/Holder", "classes/Module", "classes/Object", "classes/OrederedConfiguration", "classes/Registry", "classes/Server", "modules/Registry"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <div id="sidebar">
    <div id="classes">
        <ul id="api-classes" class="nav nav-list">
            
                <li><a href="../classes/Container.html">Container</a></li>
            
                <li><a href="../classes/DAG.html">DAG</a></li>
            
                <li><a href="../classes/EventEmitter.html">EventEmitter</a></li>
            
                <li><a href="../classes/Holder.html">Holder</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/OrederedConfiguration.html">OrederedConfiguration</a></li>
            
                <li><a href="../classes/Registry.html">Registry</a></li>
            
                <li><a href="../classes/Server.html">Server</a></li>
            
        </ul>
    </div>
    </div>
</div>

        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>lib/registry/registry.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/*jslint node: true */
&quot;use strict&quot;;

var _ = require(&#x27;lodash&#x27;),
	async = require(&#x27;async&#x27;),
	EventEmitter = require(&#x27;../event-emitter&#x27;),
	OrderedConfiguration = require(&#x27;../ordered-configuration&#x27;),
	Module = require(&#x27;../module&#x27;),
	utils = require(&#x27;../utils&#x27;),
	server = require(&#x27;../server&#x27;),
	environment = require(&#x27;./environment&#x27;),
	Holder = require(&#x27;./holder&#x27;),
	Container = require(&#x27;./container&#x27;),
	loader = require(&#x27;./loader&#x27;),
	onShutdown = require(&#x27;../shutdown&#x27;);

var SERVER_REGISTRATION_KEY = &#x27;server:main&#x27;;

/**
 * Registry Class which is a singleton.
 *
 * @class Registry
 * @extends {EventEmitter}
 */
var Registry = EventEmitter.extend({
	init: function() {
		this._super();

		_.bindAll(this);

		utils.defineProperty(this, &#x27;__container&#x27;, new Container(), {
			configurable: false
		});

		utils.defineProperty(this, &#x27;__initializers&#x27;, new OrderedConfiguration());

		this.environment = new Holder();

		this.readEnv(process.cwd() + &#x27;/.env&#x27;);

		// add process shutdown events to tear down registry
		onShutdown(this);
	},

	/**
	 * Get the module instance
	 * @method get
	 * 
	 * @param {String} name
	 * @param {Object} options
	 * @return {Module}
	 */
	get: function(name, options) {
		return this.__container.lookup(name, options);
	},

	/**
	 * Registers the folder, which contains the Modules, in the container.
	 * 
	 * @method registerFolder
	 * @param {String} location
	 * @param {Object} options
	 */
	registerFolder: function(location, options) {
		loader.scanDirectoryForModules(this, location, options);
	},

	/**
	 * Registers the Module to the container.
	 * If the module param is a string, it will require the module and extend the
	 * Module class. If the module is a Function or an Object it will register it for that name.
	 * 
	 * @method registerModule
	 * @param {String}                 name
	 * @param {String|Object|Function} module
	 * @param {Object}                 options
	 */
	registerModule: function(name, module, options) {
		if (!_.isString(name)) {
			throw new TypeError(&#x27;Module name must be a String&#x27;);
		}

		if(_.isString(module)) {
			module = loader.loadModuleFactory(module, name);

			return this.__container.register(name, module, options);
		} else if (typeof module === &#x27;function&#x27; || module instanceof Module) {
			return this.__container.register(name, module, options);
		} else if (typeof module === &#x27;object&#x27;) {
			return this.__container.register(name, Module.extend(module), options);
		}

		throw new TypeError(&#x27;Unsuproted type for Module registration&#x27;);
	},

	/**
	 * Register an initializer function that will be invoked before
	 * the server is started.
	 * 
	 * @method registerInitializer
	 * @param {Object} initializer
	 */
	registerInitializer: function(initializer) {
		if(this.isRunning) {
			throw new Error(&#x27;You can only register an initializer before the server is started.&#x27;);
		}

		var initializers = this.__initializers;

		if(initializer &amp;&amp; _.isFunction(initializer.initializer)) {
			initializers.add(initializer);
		} else {
			throw new TypeError(&#x27;Initializer must contain an initializer method&#x27;);
		}
	},

	/**
	 * Run the configured initalizers. After all of them are invoked,
	 * start up the server.
	 * You must pass a callback that will be run after initializers are finished.
	 * 
	 * @method runInitializers
	 * @param {Function} callback
	 */
	runInitializers: function(callback) {
		if(!_.isFunction(callback)) {
			throw new TypeError(&#x27;You must pass a callback function to this method.&#x27;);
		}

		var container = this.__container;

		if(!container.isRegistered(SERVER_REGISTRATION_KEY)) {
			throw new Error(&#x27;No Server has been created. Please create one before runing initializers&#x27;);
		}

		var server = this.get(SERVER_REGISTRATION_KEY);

		var tasks = this.__initializers.map(function(initializer) {
			return function(cb) {
				initializer.initializer(container, server, cb);
			};
		}, this);

		return async.series(tasks, function(err) {
			return callback(err, server);
		});
	},

	/**
	 * Create the Application Module. You will extend the {{#crossLink &quot;Server&quot;}}{{/crossLink}}
	 * module with new methods.
	 *
	 * &#x60;&#x60;&#x60;javascript
	 * var Server = Registry.createApplication(function(req, res) {
	 *     res.write(&#x27;ok&#x27;);
	 * });
	 *
	 * Server.startServer();
	 * &#x60;&#x60;&#x60;
	 * 
	 * @method createServer
	 * @param {Object|Function} app
	 * @return {Server}
	 */
	createServer: function(app) {
		if(_.isFunction(app)) {
			app = {
				listener: app
			};
		}

		if(typeof app !== &#x27;object&#x27;) {
			throw new TypeError(&#x27;You must define options or a listener for the Server&#x27;);
		}

		if(this.__container.isRegistered(SERVER_REGISTRATION_KEY)) {
			throw new Error(&#x27;Server is already created.&#x27;);
		}

		if(_.isFunction(app)) {
			app = {
				listener: app
			};
		}

		var Server = server.extend(app).extend({
			registry: this,
			container: this.__container.child()
		}).create();

		this.__container.register(SERVER_REGISTRATION_KEY, Server, {
			instantiate: false
		});

		this.once(&#x27;destroy&#x27;, Server.destroy);

		return this.get(SERVER_REGISTRATION_KEY);
	},

	/**
	 * Load more Environment properties to the Registry
	 * 
	 * @method readEnv
	 * @param {String} location Where the &#x60;env&#x60; file is located
	 * @param {Object} options
	 */
	readEnv: function(location, options) {
		environment.read(this.environment, location, options);
	},

	/**
	 * Get the execution mode of the applcation by checking if the executionMode
	 * property is set. If not it checks the environment variables by 
	 * &#x60;process.env.NODE_ENV&#x60; property.
	 * 
	 * Defaults to &#x27;development&#x27;.
	 * 
	 * @method getExecutionMode
	 * @return LogicalExpression
	 * @default development
	 */
	getExecutionMode: function() {
		return this.executionMode ||
				this.environment.get(&#x27;NODE_ENV&#x27;) ||
				process.env.NODE_ENV ||
				&#x27;development&#x27;;
	},

	/**
	 * Manualy set the execution mode in the Regsitry
	 * 
	 * @method setExecutionMode
	 * @param {String} mode
	 */
	setExecutionMode: function(mode) {
		if(!_.isString(mode)) {
			throw new TypeError(&#x27;Execution mode must be a String&#x27;);
		}

		this.executionMode = mode;
	},

	/**
	 * Detects if the application is runing in production mode
	 * 
	 * @method isProductionMode
	 * @return {Boolean}
	 */
	isProductionMode: function() {
		return this.getExecutionMode() === &#x27;production&#x27;;
	},

	/**
	 * Resets the Container, and emits a &#x27;reset&#x27; Event
	 * 
	 * @method reset
	 */
	reset: function() {
		this.__container.reset();
		this.__initializers.registrations = {};
		this.environment.data = {};

		/**
		 * Event emited each time the Registry has been reset.
		 *
		 * @event reset
		 */
		this.emit(&#x27;reset&#x27;);
	},

	/**
	 * Destroys the registry. This will close the server if it&#x27;s runnig,
	 * and destroy the Container.
	 * Ultimatly this method will exit the current process.
	 * 
	 * @method destroy
	 */
	destroy: function() {
		this._super();

		this.__container.destroy();
	}

});

/**
 * Get the Sinlgeton Registry instance.
 * 
 * @method getInstance
 * @param {} opts
 * @static
 * @return {Registry}
 */
module.exports.getInstance = function(opts) {
	if (!this.instance) {
		this.instance = Registry.create(opts || {});
	}

	return this.instance;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-57430955-1");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
</body>
</html>
