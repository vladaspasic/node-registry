<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Node-registry by vladaspasic</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/lucid.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <a href="http://vladaspasic.github.io/node-registry">
            <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
            
                Node Registry
            </h1>    
        </a>
    <div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    Node Registry API: lightweight IoC for Node applications
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Container", "classes/DAG", "classes/EventEmitter", "classes/Holder", "classes/Module", "classes/Object", "classes/OrederedConfiguration", "classes/Registry", "classes/Server"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3" id='sidebar-left'>
            <div class='repo-info'>
                

                <p>Version: 0.1.8</p>

                <p class="view"><a href="https://github.com/vladaspasic/node-registry">View the Project on GitHub <small>vladaspasic/node-registry</small></a></p>


                <ul>
                  <li><a href="https://github.com/vladaspasic/node-registry/zipball/master">Download <strong>ZIP File</strong></a></li>
                  <li><a href="https://github.com/vladaspasic/node-registry/tarball/master">Download <strong>TAR Ball</strong></a></li>
                  <li><a href="https://github.com/vladaspasic/node-registry">View On <strong>GitHub</strong></a></li>
                </ul>
            </div>

           <div>
    <div id="sidebar">
    <div id="classes">
        <ul id="api-classes" class="nav nav-list">
        	<li class="nav-header">Classes</li>
            
                <li><a href="../classes/Container.html">Container</a></li>
            
                <li><a href="../classes/DAG.html">DAG</a></li>
            
                <li><a href="../classes/EventEmitter.html">EventEmitter</a></li>
            
                <li><a href="../classes/Holder.html">Holder</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/OrederedConfiguration.html">OrederedConfiguration</a></li>
            
                <li><a href="../classes/Registry.html">Registry</a></li>
            
                <li><a href="../classes/Server.html">Server</a></li>
            
            <li class="divider"></li>
        </ul>
    </div>
    </div>
</div>

        </div>
        <div class="span9 offset3">
                <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>lib/server.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/*jslint node: true */
&quot;use strict&quot;;

var fs = require(&#x27;fs&#x27;),
	_ = require(&#x27;lodash&#x27;),
	Container = require(&#x27;./registry/container&#x27;),
	EventEmitter = require(&#x27;./event-emitter&#x27;),
	request = require(&#x27;./request&#x27;);

function checkListener(listener) {
	if (listener === undefined) {
		throw new Error(&#x27;No listener has been defined for the Server.&#x27;);
	}

	if (!_.isFunction(listener)) {
		throw new TypeError(&#x27;Listener must be a fuction.&#x27;);
	}
}

function wrapRequestListener(container, listener) {
	return function(req, res) {
		req.__setContainer(container);

		return listener(req, res);
	};

}

/**
 * Detects if the configuration contains the key and the SSL Certificate used to create a HTTPS server. &lt;br/&gt;
 * If no SSL configuration is provided, false is returned.
 *
 */
function loadSSLConfiguration(ssl) {
	return _.extend(ssl, {
		key: fs.readFileSync(ssl.key),
		cert: fs.readFileSync(ssl.cert)
	});
}

/**
 * Server Module Class that is wrapped aroung Node HTTP and HTPPS servers.
 *
 * @class Server
 * @extends {EventEmitter}
 */
module.exports = EventEmitter.extend({
	init: function() {
		if (!(this.container instanceof Container)) {
			throw new Error(&#x27;Server must be created via Registry.createServer method&#x27;);
		}

		this._super();

		if (!this.ssl) return;

		if (!this.ssl.key || !this.ssl.cert) {
			throw new Error(&#x27;Invalid SSL configuration!  Must include cert and key locations!&#x27;);
		}
	},

	/**
	 * Set the port number for the Server
	 *
	 * @type {Number}
	 * @default 8000
	 */
	port: 8000,

	/**
	 * Here you declare your SSL &#x60;key&#x60; and &#x60;cert&#x60; file location
	 * to read by the Server when a HTTPS server is created.
	 *
	 * When this property is set, the port is automatically set to &#x60;443&#x60;.
	 *
	 * @type {Object}
	 * @default null
	 */
	ssl: null,

	/**
	 * Get the module instance
	 *
	 * @method get
	 * @param {String} name
	 * @param {Object} options
	 * @return {Module}
	 */
	get: function(name, options) {
		return this.container.lookup(name, options);
	},

	/**
	 * The request listener function that should be added
	 * to the server when it&#x27;s created.
	 *
	 * @method getListener
	 * @return {Function}
	 */
	getListener: function() {
		checkListener(this.listener);

		return this.listener;
	},

	/**
	 * Set the request listener function that should be added
	 * to the server.
	 *
	 * @method setListener
	 * @param {Function} listener
	 */
	setListener: function(listener) {
		checkListener(listener);

		this.listener = listener;
	},

	/**
	 * Returns the port number to be used by the Server.
	 * If SSL parameters are configured, it will use the 443 port.
	 *
	 * @method getPort
	 * @return {Number}
	 */
	getPort: function() {
		if (this.getSSL()) {
			return 443;
		}

		return this.registry.environment.get(&#x27;port&#x27;) || this.port || 8000;
	},

	/**
	 * Returns the SSL confugration for the HTTPS server
	 *
	 * @method getSSL
	 * @return {Object}
	 */
	getSSL: function() {
		return this.ssl;
	},

	/**
	 * Register an initializer function that will be invoked before
	 * the server is started.
	 *
	 * @method registerInitializer
	 * @param {Object} initializer
	 */
	registerInitializer: function(initializer) {
		this.registry.registerInitializer(initializer);
	},

	/**
	 * Creates a HTTP server instance.
	 * If SSL is configured, it creates a HTTPS server instance.
	 *
	 * @method createServer
	 * @return Server Node.js Server instance
	 */
	createServer: function() {
		var ssl = this.getSSL(),
			listener = this.getListener(),
			server;

		// Wrap the listener to initialize the container on each request
		listener = wrapRequestListener(this.container.child(), listener);

		if (ssl) {
			ssl = loadSSLConfiguration(ssl);
			server = require(&#x27;https&#x27;).createServer(ssl, listener);
		} else {
			server = require(&#x27;http&#x27;).createServer(listener);
		}

		// assign a close event listener
		server.on(&#x27;close&#x27;, this.destroy.bind(this));

		return server;
	},

	/**
	 * Runs the initializers and starts up the server, if
	 * they are all initialized.
	 *
	 * @method start
	 * @param {Function} callback Callback to be invoked after the server is started
	 */
	start: function(callback) {
		callback = callback || _.noop;
		
		this.registry.runInitializers(function(error, server) {
			if (error) return callback.call(server, error);

			server.beforeServerStart();

			server.startServer(function(error, s) {
				if (error) return callback.call(server, error);

				server.afterServerStart(s);

				callback.call(server, null, s);
			});
		});
	},

	/**
	 * Starts the server by listening to the defined port
	 *
	 * @method startServer
	 * @param {Function} callback Callback to be invoked after the server is started
	 */
	startServer: function(callback) {
		var self = this,
			server = this.createServer(),
			port = this.getPort(),
			callback = callback || _.noop;

		try {
			server.listen(port, function() {
				self.server = server;
				self.registry.isRunning = true;

				self.afterServerStart(server);

				callback.call(self, null, server);
			});
		} catch (e) {
			callback.call(self, e);
		}
	},

	/**
	 * Stops the server
	 *
	 * @method stopServer
	 */
	stopServer: function() {
		if (!this.server) {
			throw new Error(&#x27;Can not close a server that is not yet started.&#x27;);
		}

		this.registry.isRunning = false;
		this.server.close();
	},

	/**
	 * Method to be invoked before the server is loaded
	 *
	 * @method beforeServerStart
	 * @param {} server
	 * @return
	 */
	beforeServerStart: function(server) {

	},

	/**
	 * Method to be invoked after the server is started
	 *
	 * @method afterServerStart
	 * @param {} server
	 * @return
	 */
	afterServerStart: function(server) {

	},

	/**
	 * Destroy hook, shutdowns the server
	 *
	 * @method destroy
	 */
	destroy: function() {
		if (this.server) {
			this.server.unref();
			this.server.close();
		}

		this._super();
	},

	toString: function() {
		return &#x27;Registry.Server&#x27;;
	}

});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script src="javascripts/scale.fix.js"></script>

<script>prettyPrint();</script>
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-57430955-1");
        pageTracker._trackPageview();
    } catch(err) {}
</script>
</body>
</html>
